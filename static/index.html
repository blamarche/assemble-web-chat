<!doctype html>
<html>
<!--
This file is part of Assemble Web Chat.

Foobar is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

Foobar is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with Assemble Web Chat.  If not, see <http://www.gnu.org/licenses/>.
-->
  <head>
    <title>Assemble Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; width: 100%; height: 100%;}
      form { background: #000; padding: 3px; position: fixed; bottom: 0; left: 0; width: 100%; }
      form input { border: 0; padding: 10px; width: 85%;}
      form button { padding: 10px; height:36px !important; width:10%; overflow:hidden; }
      #messages { list-style-type: none; margin: 0; padding: 0; margin-bottom: 50px; padding-left: 150px;}
      #messages li { padding: 5px 10px; clear:both; }
      #messages li:nth-child(odd) { background: #eee; }
      #messages li a.joinroom {
          display: block;
          float: left;
          background: #0a7;
          color: white;
          font-weight: bold;
          border-radius: 10px;
          padding: 2px 10px;
          margin-right: 5px;
          cursor:pointer;
      }
      #messages li a.autolink {
      }
      #messages li img.autolink {
          width: 100%;
      }
      #sidebar {
          background:#555;
          color:#eee;
          height: 100%;
          width: 150px;
          float:left;
          list-style-type: none;
          margin: 0;
          padding: 0;
          margin-bottom: 50px;
          overflow-y: scroll;
          position: fixed;
          top: 0;
          left: 0;
      }
      #sidebar li { padding: 8px 8px; font-size: 14px; border-bottom: 1px solid #666; cursor:pointer; }
      #sidebar li:nth-child(odd) { background: #333; }
      #sidebar li.active { background: #0a6; }
      #sidebar li span {
          float: right;
          display: block;
          margin-top: -19px;
          background-color: #777;
          border-radius: 50px;
          padding: 0px 5px;
          font-size: 12px;
          font-weight: bold;
      }
      #sidebar li div {
          display: block;
          margin-top: 3px;
      }
      .hidden { display: none; }

      @media (max-width: 480px) {
          #messages { padding-left: 70px; }
          #sidebar { width: 70px; }
      }
    </style>

    <script src="/socket.io.js"></script>
    <script src="/jquery-1.11.1.js"></script>
    <script src="/Autolinker.min.js"></script>
    <script src="/bootstrap/js/bootstrap.min.js"></script>
  </head>

  <body>
    <div class="container-fluid">

        <!-- UI -->
        <div class="row">
            <ul id="sidebar"></ul>
            <ul id="messages"></ul>
        </div>

        <form action="">
          <input id="m" autocomplete="off" />
          <button class="btn btn-success"><span class="glyphicon glyphicon-send" aria-hidden="true"></span></button>
        </form>

    </div>

    <!-- JS -->
    <script>
    $(document).ready(function(){
        $( window ).resize(function() {
            updateSidebar();
        });
    });

    var socket = io("", {reconnectionDelayMax:500, reconnectionDelay:500, timeout: 5000, multiplex:false});

    var rooms = {};
    var roomnames = {};
    var cur_room = "";
    var cur_dur = "24h";
    var token = window.location.hash.substring(1);

    $(window).on('beforeunload', function(){
        socket.close();
    });

    $('form').submit(function(){
        var m = $('#m').val();
        if (m[0]=="/") {
            handleCommand(socket,m);
        } else {
            socket.emit('chatm', JSON.stringify({"t": token, "room": cur_room, "m": m, "dur":cur_dur}));
            $('#m').val('');
            $("#m").prop('disabled', true);
        }
        return false;
    });

    //error in js seems to break socket connection, wrap in try catch?
    socket.on('connect', function(d) {
        socket.emit("auth", token);
    });

    socket.on('chatm', function(d){
        //console.log(d);
        d=JSON.parse(d);
        appendChatMessage(d.room,d.name,d.nick,d.m,d.msgid);
        rooms[d.room].messages.push(d);
        scrollToBottom();
        $("#m").prop('disabled', false);

        if (cur_room!=d.room) {
            rooms[d.room].mcount++;
            updateSidebar();
        }
    });

    socket.on('roomlist', function(d){
        d=JSON.parse(d);
        var m = "";
        for (var k in d) {
            m+="<a class='joinroom' data-room='"+k+"'>"+d[k]+"</a>"
        }
        $('#messages').append($('<li>').html(m));
        $('#messages li a.joinroom').on('click', function(ev){
            var rm = $(ev.currentTarget).attr("data-room");
            socket.emit("join", JSON.stringify({"t": token, "roomid": rm}));
            if (typeof rooms[rm]!="undefined") {
                switchRoom(rm);
                updateSidebar();
            }
            return false;
        });
    });

    socket.on('history', function(d){
        d=JSON.parse(d);
        //console.log(d);
        for (var i=0; i<d.history.length; i++) {
            appendChatMessage(d.room,d.name,d.history[i].nick,d.history[i].m,d.history[i].msgid);
            rooms[d.room].messages.push(d.history[i]);
        }

        updateSidebar();
        scrollToBottom();
    });

    socket.on('join', function(d){
        d=JSON.parse(d);
        $('#messages').append($('<li>').text("Joined "+d.name));
        rooms[d.room] = {users: [], messages: [], friendlyname: d.name, mcount: 0};
        roomnames[d.name] = d.room;
        switchRoom(d.room);
        updateSidebar();
    });

    socket.on('joined', function(d){
        d=JSON.parse(d);
        $('#messages').append($('<li>').text(d.nick +" joined "+d.name));
        rooms[d.room].users.push({uid:d.uid, nick:d.nick});
    });

    socket.on('auth_error', function(d){
        $('#messages').append($('<li>').text("Error: "+d));
        $("#m").prop('disabled', false);
    });

    socket.on('auth', function(d){
        $('#messages').append($('<li>').text("Logged in successfully"));
    });

    socket.on('invitenewuser', function(d){
        d=JSON.parse(d);
        $('#messages').append($('<li>').text("Invite Key: "+d.key));
    });

    socket.on('deletechatm', function(d){
        //appendChatMessage("lobby","SYSTEM","Message deleted "+d,"");
        $("#messages li[data-msgid='"+d+"']").html("<i>Removed message</i>");
    });

    function updateSidebar() {
        //update sidebar to hold message counts and list active chat rooms
        for (var r in rooms) {
            var rm = rooms[r];
            if ($("#sidebar li[data-room='"+r+"']").length == 0) {
                $("#sidebar").append($("<li>")
                    .attr("data-room", r)
                    .html("<div>"+rm.friendlyname+"</div><span></span>")
                    .on('click', function(ev) {
                        var rm = $(ev.currentTarget).attr("data-room");
                        switchRoom(rm);
                    })
                );
            }

            if (rm.mcount > 0) {
                $("#sidebar li[data-room='"+r+"'] span").html(rm.mcount);
            } else {
                $("#sidebar li[data-room='"+r+"'] span").text("");
            }
            if (r == cur_room) {
                $("#sidebar li.active").removeClass("active");
                $("#sidebar li[data-room='"+r+"']").addClass("active");
            }
        }
        $("#sidebar").css("height", (window.innerHeight-42)+"px");
    }

    function scrollToBottom() {
        $("#messages").scrollTop($('#messages')[0].scrollHeight);
    }

    function appendChatMessage(room, roomname, nick, m, id) {
        //TODO add timestamp to mesage
        var hide = "";
        if (room!=cur_room) {
            hide="hidden";
        }

        var tmp = $('<div>')
        tmp.text(m);
        m=tmp.text();

        m = Autolinker.link(m, {
            stripPrefix: false,
            truncate: 30,
            className:"autolink",
            twitter:false,
            hashtag: false,
            replaceFn : function( autolinker, match ) {
                href = match.getAnchorHref();
                switch( match.getType() ) {
                    case 'url' :
                        if ( match.getUrl().indexOf( '.jpg' ) !== -1 ||
                             match.getUrl().indexOf( '.jpeg' ) !== -1 ||
                             match.getUrl().indexOf( '.png' ) !== -1 ||
                             match.getUrl().indexOf( '.gif' ) !== -1  )
                        {
                            return "<a href='"+href+"' target='_blank'>"+href+"</a><br><img src='"+href+"' class='autolink'></img>";
                        }
                        break;
                }
                return;
            }
        });

        $('#messages').append($('<li>')
            .html(roomname+":"+nick+":"+m)
            .attr("data-msgid", id)
            .attr("data-room", room)
            .attr("title",id)
            .addClass("chatmsg")
            .addClass(hide)
            .on("click",function(ev) {
                var msgid = $(ev.currentTarget).attr("data-msgid")
                requestDeleteMessage(msgid);
            })
        );
    }

    function requestDeleteMessage(msgid) {
        socket.emit("deletechatm", JSON.stringify({
            "t": token,
            "room": cur_room,
            "msgid": msgid
        }));
    }

    function switchRoom(room) {
        if (typeof rooms[room]=="undefined") {
            appendChatMessage("lobby", "Lobby", "SYSTEM", "Unknown room", "");
        } else {
            cur_room = room;
        }

        $("#messages li.chatmsg").addClass("hidden");
        $("#messages li.chatmsg[data-room='"+cur_room+"']").removeClass("hidden");

        rooms[cur_room].mcount = 0;

        updateSidebar();
        scrollToBottom();
    }

    function switchRoomByName(roomname) {
        var new_room = roomnames[roomname];
        if (new_room==null || typeof roomnames[roomname]=="undefined") {
            appendChatMessage("lobby", "Lobby", "SYSTEM", "Unknown room", "");
        } else {
            switchRoom(new_room);
        }
    }

    function handleCommand(socket,c) {
        var ca = c.split(" ");
        switch (ca[0]) {
            case "/help":
                $('#messages').append($('<li>').html(" \
                    /invitenewuser email - Emails and makes an invite key for a new user to signup <br>\
                    /leave - Leaves the current room <br>\
                    /ban admin uid - Bans the UID permanently <br>\
                    /unban admin uid - UnBans the UID <br>\
                    /dur message-duration - Sets your message expiration time (ie: 24h, 10m, 30s, etc) <br>\
                    /join room-name - Attempts to join a room by name <br>\
                    /switch room-name - Switches your chat focus to a room by name <br>\
                    /createpub room-name max-history min-message-duration max-message-duration - Creates a public chat room. max-history is the max number of messages to store. max/min-duration set params for how long messages last (ie: 24h, 10m, 30s, etc) <br>\
                    /roomlist - Lists all public rooms with links to join <br>\
                "));
                break;
            case "/invitenewuser":
                var email = ca[1];
                socket.emit("invitenewuser", JSON.stringify({"t": token, "email": email}));
                break;
            case "/leave":
                socket.emit("leave", JSON.stringify({"t": token, "room": cur_room}));
                break;
            case "/ban":
                var pass = ca[1];
                var uid = ca[2];
                socket.emit("ban", JSON.stringify({"t": token, "pass": pass, "uid": uid}));
                break;
            case "/unban":
                var pass = ca[1];
                var uid = ca[2];
                socket.emit("unban", JSON.stringify({"t": token, "pass": pass, "uid": uid}));
                break;
            case "/dur":
                var dur = ca[1];
                cur_dur = dur;
                break;
            case "/join":
                var roomname = c.substring(6);
                socket.emit("join", JSON.stringify({"t": token, "roomname": roomname}));
                break;
            case "/switch":
                var roomname = c.substring(8);
                switchRoomByName(roomname);
                updateSidebar();
                break;
            case "/createpub":
                var roomname = c.substring(11);
                socket.emit("createroom", JSON.stringify({"t": token, "roomname": roomname, "private":false}));
                break;
            case "/roomlist":
                socket.emit("roomlist",JSON.stringify({"t": token}));
                break;
            default:
                $('#messages').append($('<li>').text("Unknown command"));
                break;
        }
        $('#m').val('');
    }

    </script>

  </body>
</html>
